<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±‰å­—å¯»å® - å¬éŸ³è§£é”ç´¯è®¡ç‰ˆ</title>
    <style>
        :root {
            --p: #ff7e5f; --s: #feb47b; 
            --bg: #fdf6e3; --panel: #ffffff;
            --red-btn: #d32f2f; --red-btn-light: #ff5252;
            --green: #43a047; --wrong: #e53935;
            --door-bg: #4a148c;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            display: flex; align-items: center; justify-content: center;
            height: 100dvh; width: 100vw; overflow: hidden;
            user-select: none;
        }

        #game-stage {
            width: 95vw; max-width: 800px;
            height: 95vh; max-height: 750px;
            background: var(--panel);
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            position: relative;
            display: none; flex-direction: column;
            padding: 15px; box-sizing: border-box;
        }

        .header {
            display: flex; justify-content: space-between;
            font-size: 1.1rem; font-weight: bold; color: #444;
            padding: 5px 10px; border-bottom: 2px solid #f0f0f0;
        }

        #level-content {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow: hidden; width: 100%; position: relative;
        }

        /* --- åº•éƒ¨ UI --- */
        .bottom-ui {
            height: 90px; display: flex; justify-content: space-between;
            align-items: flex-end; padding: 0 5px 10px 5px; pointer-events: none; 
        }

        #clue-tray {
            pointer-events: auto;
            display: flex; gap: 5px; padding: 8px;
            background: rgba(255, 126, 95, 0.05); 
            border-radius: 15px; border: 2px dashed var(--p); 
            width: 60%; height: 80px; align-items: center; overflow-x: auto;
            position: relative; transition: 0.3s;
        }
        #clue-tray.drag-active {
            background: rgba(255, 215, 64, 0.2);
            border-color: #ffca28;
            box-shadow: 0 0 15px rgba(255, 202, 40, 0.4);
        }
        #clue-tray::before {
            content: "æ”¶é›†è¢‹"; position: absolute; top: -20px; left: 5px;
            font-size: 0.7rem; color: var(--p); font-weight: bold;
        }

        .clue-item {
            background: #fff; border: 1px solid #ffd54f;
            border-radius: 8px; padding: 4px 6px;
            display: flex; flex-direction: column; align-items: center; min-width: 36px;
        }
        .clue-pinyin { font-size: 0.6rem; color: #795548; }
        .clue-char { font-size: 1rem; font-weight: bold; }
        
        .coin-status {
            pointer-events: auto;
            background: linear-gradient(135deg, #ffd700, #ff8f00);
            padding: 10px 20px; border-radius: 30px;
            font-weight: bold; font-size: 1.2rem; color: #fff;
            box-shadow: 0 4px 0 #e65100; display: flex; align-items: center; gap: 8px;
            margin-bottom: 15px; margin-right: 5px;
            transition: transform 0.2s;
        }
        .coin-pop { animation: popScale 0.3s ease-out; }
        @keyframes popScale { 0%{transform:scale(1);} 50%{transform:scale(1.3);} 100%{transform:scale(1);} }

        .card {
            width: 75px; height: 75px; background: white; 
            border: 3px solid var(--s); border-radius: 15px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 1.8rem; font-weight: bold; transition: 0.2s;
            box-shadow: 0 5px 0 #ddd; margin: 6px;
        }
        .card:active { transform: translateY(4px); box-shadow: 0 1px 0 #ddd; }

        .arcade-box {
            width: 280px; height: 400px; background: #3949ab;
            border: 8px solid #1a237e; border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; padding: 15px;
            position: relative; box-shadow: 0 8px 0 #0d47a1;
        }
        .arcade-screen {
            width: 100%; height: 160px; background: #000;
            border-radius: 10px; border: 4px solid #555;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #76ff03; font-family: monospace; font-size: 1.2rem; text-align: center;
            text-shadow: 0 0 5px #76ff03; overflow: hidden; position: relative;
        }
        .control-panel {
            width: 100%; display: flex; justify-content: space-around; 
            align-items: center; margin-top: 30px;
        }
        .coin-slot {
            width: 15px; height: 55px; background: #222;
            border: 4px solid #ffd700; border-radius: 6px;
            position: relative; cursor: pointer;
        }
        .start-btn {
            width: 70px; height: 70px; background: #90a4ae;
            border-radius: 50%; border: 4px solid #546e7a;
            box-shadow: 0 6px 0 #37474f; 
            display: flex; align-items: center; justify-content: center;
            color: rgba(255,255,255,0.5); font-weight: bold; font-size: 0.9rem;
            cursor: not-allowed; transition: 0.3s;
        }
        .start-btn.active {
            background: var(--red-btn-light); border-color: var(--red-btn);
            box-shadow: 0 6px 0 #b71c1c; color: white; cursor: pointer; 
            animation: btnPulse 1s infinite;
        }
        
        .coin-obj {
            width: 45px; height: 45px; background: radial-gradient(circle, #ffd700, #ff8f00);
            border-radius: 50%; border: 2px solid #b8860b; cursor: grab;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #5d4037; box-shadow: 0 3px 0 #5d4037;
        }

        .lock-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            padding: 20px; background: rgba(0,0,0,0.1); border-radius: 20px;
        }
        .rune-stone {
            width: 70px; height: 70px; background: #fff;
            border: 4px solid #673ab7; color: #512da8;
            border-radius: 12px; font-size: 1.8rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 0 #4527a0; transition: 0.2s;
        }
        .rune-stone.solved {
            background: #81c784; border-color: #2e7d32; color: white;
            box-shadow: none; transform: translateY(4px); cursor: default;
        }

        .magic-world {
            width: 100%; height: 100%; background: linear-gradient(135deg, #311b92, #673ab7);
            border-radius: 20px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; text-align: center;
        }

        #setup-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.92);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
        }
        .setup-panel { background: white; padding: 30px; border-radius: 25px; text-align: center; width: 85%; max-width: 350px; }
        .hidden { display: none !important; }
    </style>
</head>
<body id="main-body">

    <div id="setup-screen">
        <div class="setup-panel">
            <h2 style="color:var(--p)">ğŸ¦ æ±‰å­—æ¢é™©å¯åŠ¨</h2>
            <p>è¾“å…¥è¦å­¦ä¹ çš„æ±‰å­—ï¼š</p>
            <input type="text" id="words-input" value="å±± æ°´ æ—¥ æœˆ" style="width: 85%; padding: 12px; margin-bottom: 20px; border: 2px solid #eee; border-radius: 10px; font-size: 1rem;">
            <br>
            <button onclick="Game.start()" style="padding: 12px 40px; background: var(--p); color: white; border: none; border-radius: 25px; font-weight: bold; cursor: pointer;">å‡ºå‘ï¼</button>
        </div>
    </div>

    <div id="game-stage">
        <div class="header">
            <div id="level-tag">å…³å¡: 1/4</div>
            <div id="msg-hint" style="color: var(--p); font-size: 0.95rem;"></div>
        </div>
        <div id="level-content"></div>
        <div class="bottom-ui">
            <div id="clue-tray"></div>
            <div class="coin-status">ğŸ’° <span id="coin-val">0</span></div>
        </div>
    </div>

<script>
const PinyinDict = {"å±±":"shÄn","æ°´":"shuÇ","æ—¥":"rÃ¬","æœˆ":"yuÃ¨","å¤©":"tiÄn","åœ°":"dÃ¬","äºº":"rÃ©n","å£":"kÇ’u","æ‰‹":"shÇ’u","è¶³":"zÃº","å¤§":"dÃ ","å°":"xiÇo","å¤š":"duÅ","å°‘":"shÇo"};

const AudioSys = {
    speak(t) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'zh-CN'; u.rate = 0.85;
        window.speechSynthesis.speak(u);
    },
    playTone(freq, type='sine', dur=0.3) {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = type; osc.frequency.value = freq; osc.connect(g); g.connect(ctx.destination);
        osc.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
        osc.stop(ctx.currentTime + dur);
    }
};

const Game = {
    words: [], collected: [], coins: 0, level: 1, walletSize: 0,
    
    start() {
        // --- æ ¸å¿ƒæ›´æ–°ï¼šä»æœ¬åœ°å­˜å‚¨è¯»å–ç´¯è®¡é‡‘å¸ ---
        const savedCoins = localStorage.getItem('hjtx_total_coins');
        this.coins = savedCoins ? parseInt(savedCoins) : 0;

        const raw = document.getElementById('words-input').value.trim();
        this.words = raw.split(/\s+/).filter(x => x);
        if(this.words.length < 1) return alert("è¯·è¾“å…¥æ±‰å­—");
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-stage').style.display = 'flex';
        this.initL1();
    },

    updateUI() {
        document.getElementById('level-tag').textContent = `å…³å¡: ${this.level}/4`;
        const cVal = document.getElementById('coin-val');
        if (cVal.textContent != this.coins) {
            cVal.textContent = this.coins;
            document.querySelector('.coin-status').classList.add('coin-pop');
            setTimeout(()=>document.querySelector('.coin-status').classList.remove('coin-pop'), 300);
            // --- æ ¸å¿ƒæ›´æ–°ï¼šé‡‘å¸å˜åŠ¨å³ä¿å­˜ï¼Œå®ç°è·¨å±€ç´¯è®¡ ---
            localStorage.setItem('hjtx_total_coins', this.coins);
        }
    },

    setHint(t) { document.getElementById('msg-hint').textContent = t; },

    addClue(w) {
        if(this.collected.includes(w)) return;
        this.collected.push(w);
        const tray = document.getElementById('clue-tray');
        const item = document.createElement('div');
        item.className = 'clue-item';
        item.innerHTML = `<span class="clue-pinyin">${PinyinDict[w]||''}</span><span class="clue-char">${w}</span>`;
        tray.appendChild(item);
        tray.scrollLeft = tray.scrollWidth;
    },

    initL1() {
        this.level = 1; this.updateUI();
        this.setHint("ç®—å‡ºå¾—æ•°ï¼Œæ‹–åŠ¨æ­£ç¡®çš„æ±‰å­—ï¼");
        const cont = document.getElementById('level-content');
        let idx = 0;
        const renderTask = () => {
            if(idx >= this.words.length) return setTimeout(() => this.initL2(), 1200);
            const a = Math.floor(Math.random()*5)+1, b = Math.floor(Math.random()*4)+1;
            cont.innerHTML = `<div style="font-size:3rem; margin-bottom:30px; font-weight:bold; color:#555;">${a} + ${b} = ?</div><div id="L1-grid" style="display:flex; gap:15px;"></div>`;
            const grid = document.getElementById('L1-grid');
            [a+b, a+b+1, a+b-1].sort(()=>Math.random()-0.5).forEach(v => {
                const c = document.createElement('div');
                c.className = 'card'; c.textContent = v;
                c.onclick = () => {
                    if(v === a+b) {
                        AudioSys.playTone(600); const w = this.words[idx];
                        c.innerHTML = `<span style="font-size:0.6rem">${PinyinDict[w]||''}</span>${w}`;
                        c.style.background = "#fff9c4"; c.draggable = true;
                        c.ondragstart = (e) => { e.dataTransfer.setData('text/plain', w); document.getElementById('clue-tray').classList.add('drag-active'); };
                        c.ondragend = () => document.getElementById('clue-tray').classList.remove('drag-active');
                        AudioSys.speak(w);
                    } else AudioSys.playTone(150, 'square');
                };
                grid.appendChild(c);
            });
        };
        const tray = document.getElementById('clue-tray');
        tray.ondragover = e => e.preventDefault();
        tray.ondrop = e => { e.preventDefault(); tray.classList.remove('drag-active'); const w = e.dataTransfer.getData('text/plain'); if(w && !['gold'].includes(w)) { this.addClue(w); idx++; renderTask(); }};
        renderTask();
    },

    initL2() {
        this.level = 2; this.updateUI();
        this.setHint("ç‚¹ä¸­è¯»éŸ³å¯¹åº”çš„å­—ï¼Œèµšå–åˆå§‹é‡‘å¸ï¼");
        const cont = document.getElementById('level-content');
        this.walletSize = 0;
        let queue = [...this.words].sort(() => Math.random() - 0.5);
        let qIndex = 0;
        const nextQ = () => {
            if(qIndex >= queue.length) return setTimeout(()=>this.initL3(), 1500);
            const target = queue[qIndex];
            
            // --- æ ¸å¿ƒæ›´æ–°ï¼šå–‡å­å›¾æ ‡å¢åŠ ç‚¹å‡»é‡æ’­åŠŸèƒ½ ---
            cont.innerHTML = `
                <div onclick="AudioSys.speak('${target}')" style="font-size:4rem; cursor:pointer; margin-bottom:20px;">ğŸ”Š</div>
                <div id="L2-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px;"></div>`;
            
            AudioSys.speak(target);
            const grid = document.getElementById('L2-grid');
            Array.from(new Set([target, ...this.words, 'å¤§','å¤©','åœŸ','æœ¨'])).slice(0,6).sort(()=>Math.random()-0.5).forEach(w => {
                const c = document.createElement('div'); c.className = 'card'; c.textContent = w;
                c.onclick = () => { if(w === target) { AudioSys.playTone(1000); this.coins+=1; this.walletSize++; this.updateUI(); qIndex++; nextQ(); } else AudioSys.playTone(200, 'sawtooth'); };
                grid.appendChild(c);
            });
        };
        nextQ();
    },

    initL3() {
        this.level = 3; this.updateUI();
        this.setHint(`æŠ•å…¥é‡‘å¸å¯åŠ¨æœºå™¨ï¼Œç©æ¸¸æˆèµšæ›´å¤šé’±ï¼`);
        const cont = document.getElementById('level-content');
        cont.innerHTML = `<div style="display:flex; gap:20px; align-items:center;"><div id="purse" style="width:90px; height:200px; display:flex; flex-wrap:wrap; align-content:flex-start; gap:5px; border:2px solid #ddd; border-radius:15px; padding:10px; overflow-y:auto; background:#fff;"></div><div class="arcade-box"><div class="arcade-screen" id="arcade-scr">INSERT<br>COINS</div><div class="control-panel"><div class="coin-slot" id="target-slot"></div><div id="btn-start" class="start-btn">START</div></div></div></div>`;
        const purse = document.getElementById('purse');
        for(let i=0; i<this.walletSize; i++) { const c = document.createElement('div'); c.className = 'coin-obj'; c.textContent = 'Â¥'; c.draggable = true; c.ondragstart = e => e.dataTransfer.setData('type', 'gold'); purse.appendChild(c); }
        let inserted = 0; const req = this.walletSize; 
        const slot = document.getElementById('target-slot');
        slot.ondragover = e => e.preventDefault();
        slot.ondrop = e => {
            if(e.dataTransfer.getData('type') === 'gold' && purse.lastChild) {
                purse.lastChild.remove(); AudioSys.playTone(1200);
                if(this.coins > 0) this.coins--; this.updateUI();
                inserted++; document.getElementById('arcade-scr').innerHTML = `CREDITS<br>${inserted}`;
                if(inserted >= req) this.enableStartButton();
            }
        };
    },
    enableStartButton() {
        const btn = document.getElementById('btn-start');
        document.getElementById('arcade-scr').innerHTML = "PRESS<br>START";
        document.getElementById('arcade-scr').style.color = "#ffff00";
        btn.classList.add('active');
        btn.onclick = () => { AudioSys.playTone(1500, 'square'); btn.classList.remove('active'); this.startListeningMoleGame(); };
    },
    startListeningMoleGame() {
        const scr = document.getElementById('arcade-scr'); scr.innerHTML = "";
        const topBar = document.createElement('div');
        topBar.style.cssText = "width:100%; height:30px; background:#222; color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:0.8rem; border-bottom:1px solid #444;";
        topBar.innerHTML = "ğŸ”Š ç‚¹å‡»é‡æ’­"; scr.appendChild(topBar);
        const grid = document.createElement('div');
        grid.style.cssText = "display:grid; grid-template-columns:repeat(3,1fr); width:100%; height:125px; gap:6px; padding:4px; box-sizing:border-box;"; scr.appendChild(grid);
        const holes = [];
        for(let i=0; i<3; i++) {
            const h = document.createElement('div'); h.style.cssText = "background:#111; position:relative; overflow:hidden; border-radius:4px;";
            const m = document.createElement('div'); m.style.cssText = "width:100%; height:100%; background:#ffa000; position:absolute; bottom:-100%; transition:bottom 0.2s; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#3e2723; cursor:pointer; font-size:1.5rem;";
            h.appendChild(m); grid.appendChild(h); holes.push(m);
        }
        let round = 0;
        const playRound = () => {
            if(round >= 5) return setTimeout(()=>this.initL4(), 1000);
            const target = this.words[Math.floor(Math.random()*this.words.length)];
            const opts = [target, "å¤§", "äºº"].sort(()=>Math.random()-0.5);
            topBar.onclick = () => AudioSys.speak(target);
            AudioSys.speak(target);
            holes.forEach((m, idx) => {
                m.textContent = opts[idx]; m.style.background = "#ffa000"; m.style.bottom = "0";
                m.onclick = () => {
                    if(opts[idx] === target) {
                        m.style.background = "var(--green)"; AudioSys.playTone(1000);
                        this.coins += 2; this.updateUI(); round++;
                        holes.forEach(h => h.style.bottom = "-100%"); setTimeout(playRound, 1200);
                    } else AudioSys.playTone(150, 'sawtooth');
                };
            });
        };
        playRound();
    },

    initL4() {
        this.level = 4; this.updateUI();
        this.setHint("å¬å£°éŸ³ï¼Œè§£å¼€é­”æ³•é”ï¼(å¥–åŠ±: 5é‡‘å¸/å­—)");
        const cont = document.getElementById('level-content');
        cont.innerHTML = `<div style="font-size:3rem; margin-bottom:10px;">ğŸšª ğŸ”’</div><div id="play-btn-L4" style="font-size:1.5rem; background:#eee; padding:5px 20px; border-radius:20px; cursor:pointer; margin-bottom:15px;">ğŸ”Š ç‚¹å‡»å¬å¯†ç </div><div id="lock-grid" class="lock-grid"></div>`;
        const grid = document.getElementById('lock-grid');
        const puzzleWords = [...this.words].sort(() => Math.random() - 0.5);
        puzzleWords.forEach(w => {
            const btn = document.createElement('div'); btn.className = 'rune-stone'; btn.id = `rune-${w}`; btn.textContent = w; grid.appendChild(btn);
        });
        let sequence = [...this.words].sort(() => Math.random() - 0.5);
        let currentStep = 0;
        const askForNext = () => {
            if(currentStep >= sequence.length) return setTimeout(() => this.initMagicWorld(), 1500);
            const target = sequence[currentStep];
            const playBtn = document.getElementById('play-btn-L4');
            const playSound = () => { AudioSys.speak("è¯·ç‚¹å‡» " + target); };
            playBtn.onclick = playSound; playSound();
            puzzleWords.forEach(w => {
                const btn = document.getElementById(`rune-${w}`);
                if(btn.classList.contains('solved')) return;
                btn.onclick = () => {
                    if(w === target) {
                        btn.classList.add('solved'); btn.onclick = null; AudioSys.playTone(880);
                        this.coins += 5; this.updateUI(); currentStep++; setTimeout(askForNext, 1000);
                    } else { AudioSys.playTone(150, 'sawtooth'); if(this.coins > 0) {this.coins--; this.updateUI();} }
                };
            });
        };
        setTimeout(askForNext, 1000);
    },

    initMagicWorld() {
        this.level = "é€šå…³"; this.updateUI();
        const cont = document.getElementById('level-content');
        cont.innerHTML = `<div class="magic-world"><h2>âœ¨ é­”æ³•ä¹å›­ âœ¨</h2><div id="dancer" style="font-size:6rem;">ğŸ¦</div><div style="background:rgba(255,255,255,0.2); padding:15px; border-radius:15px; margin-top:20px;"><div style="display:flex; gap:10px;"><button onclick="Game.doDance('ğŸ¦', 5)" class="shop-btn">ğŸ¦ è·³èˆ (5ğŸ’°)</button><button onclick="Game.doDance('ğŸ‰', 30)" class="shop-btn special">ğŸ‰ ç¥é¾™ (30ğŸ’°)</button></div></div><button onclick="location.reload()" style="margin-top:25px; border:1px solid #fff; background:transparent; color:#fff; padding:8px 20px; border-radius:20px;">å†æ¥ä¸€å±€</button></div>`;
        const style = document.createElement('style');
        style.innerHTML = `.shop-btn { padding:10px; border:none; border-radius:10px; cursor:pointer; background:#fff; font-weight:bold; } .shop-btn.special { background: gold; }`;
        document.head.appendChild(style);
    },

    doDance(icon, cost) {
        if(this.coins < cost) return alert("é‡‘å¸ä¸è¶³ï¼");
        this.coins -= cost; this.updateUI();
        const d = document.getElementById('dancer'); d.textContent = icon;
        d.animate([{transform:'scale(1)'},{transform:'scale(1.5) rotate(360deg)'},{transform:'scale(1)'}], {duration:1000});
        AudioSys.playTone(1000);
    }
};
</script>
</body>

</html>
