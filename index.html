<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>æ±‰å­—å¯»å® - å¬éŸ³è§£é”ç´¯è®¡ç‰ˆï¼ˆç§»åŠ¨ç«¯è‡ªé€‚åº”ï¼‰</title>
    <style>
        :root {
            --p: #ff7e5f; --s: #feb47b; 
            --bg: #fdf6e3; --panel: #ffffff;
            --red-btn: #d32f2f; --red-btn-light: #ff5252;
            --green: #43a047; --wrong: #e53935;
            --door-bg: #4a148c;
        }

        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            display: flex; align-items: center; justify-content: center;
            height: 100dvh; width: 100vw; overflow: hidden;
            user-select: none;
        }

        #game-stage {
            width: 95vw; max-width: 800px;
            height: 95vh; max-height: 750px;
            background: var(--panel);
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            position: relative;
            display: none; flex-direction: column;
            padding: 15px; box-sizing: border-box;
        }

        .header {
            display: flex; justify-content: space-between;
            font-size: 1.1rem; font-weight: bold; color: #444;
            padding: 5px 10px; border-bottom: 2px solid #f0f0f0;
        }

        #level-content {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow: hidden; width: 100%; position: relative;
        }

        /* --- åº•éƒ¨ UI --- */
        .bottom-ui {
            height: 90px; display: flex; justify-content: space-between;
            align-items: flex-end; padding: 0 5px 10px 5px; pointer-events: none; 
        }

        #clue-tray {
            pointer-events: auto;
            display: flex; gap: 5px; padding: 8px;
            background: rgba(255, 126, 95, 0.05); 
            border-radius: 15px; border: 2px dashed var(--p); 
            width: 60%; height: 80px; align-items: center; overflow-x: auto;
            position: relative; transition: 0.3s;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        #clue-tray::-webkit-scrollbar { display: none; }
        #clue-tray.drag-active {
            background: rgba(255, 215, 64, 0.2);
            border-color: #ffca28;
            box-shadow: 0 0 15px rgba(255, 202, 40, 0.4);
        }
        #clue-tray::before {
            content: "æ”¶é›†è¢‹"; position: absolute; top: -20px; left: 5px;
            font-size: 0.7rem; color: var(--p); font-weight: bold;
        }

        .clue-item {
            background: #fff; border: 1px solid #ffd54f;
            border-radius: 8px; padding: 4px 6px;
            display: flex; flex-direction: column; align-items: center; min-width: 36px;
        }
        .clue-pinyin { font-size: 0.6rem; color: #795548; }
        .clue-char { font-size: 1rem; font-weight: bold; }
        
        .coin-status {
            pointer-events: auto;
            background: linear-gradient(135deg, #ffd700, #ff8f00);
            padding: 10px 20px; border-radius: 30px;
            font-weight: bold; font-size: 1.2rem; color: #fff;
            box-shadow: 0 4px 0 #e65100; display: flex; align-items: center; gap: 8px;
            margin-bottom: 15px; margin-right: 5px;
            transition: transform 0.2s;
            min-height: 44px;
        }
        .coin-pop { animation: popScale 0.3s ease-out; }
        @keyframes popScale { 0%{transform:scale(1);} 50%{transform:scale(1.3);} 100%{transform:scale(1);} }

        .card {
            width: 75px; height: 75px; background: white; 
            border: 3px solid var(--s); border-radius: 15px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 1.8rem; font-weight: bold; transition: 0.2s;
            box-shadow: 0 5px 0 #ddd; margin: 6px;
            min-height: 44px; min-width: 44px;
        }
        .card:active { transform: translateY(4px) scale(0.95); box-shadow: 0 1px 0 #ddd; }

        .arcade-box {
            width: 280px; height: 400px; background: #3949ab;
            border: 8px solid #1a237e; border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; padding: 15px;
            position: relative; box-shadow: 0 8px 0 #0d47a1;
        }
        .arcade-screen {
            width: 100%; height: 160px; background: #000;
            border-radius: 10px; border: 4px solid #555;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #76ff03; font-family: monospace; font-size: 1.2rem; text-align: center;
            text-shadow: 0 0 5px #76ff03; overflow: hidden; position: relative;
        }
        .control-panel {
            width: 100%; display: flex; justify-content: space-around; 
            align-items: center; margin-top: 30px;
        }
        .coin-slot {
            width: 15px; height: 55px; background: #222;
            border: 4px solid #ffd700; border-radius: 6px;
            position: relative; cursor: pointer;
        }
        .start-btn {
            width: 70px; height: 70px; background: #90a4ae;
            border-radius: 50%; border: 4px solid #546e7a;
            box-shadow: 0 6px 0 #37474f; 
            display: flex; align-items: center; justify-content: center;
            color: rgba(255,255,255,0.5); font-weight: bold; font-size: 0.9rem;
            cursor: not-allowed; transition: 0.3s;
            min-height: 44px; min-width: 44px;
        }
        .start-btn.active {
            background: var(--red-btn-light); border-color: var(--red-btn);
            box-shadow: 0 6px 0 #b71c1c; color: white; cursor: pointer; 
            animation: btnPulse 1s infinite;
        }
        @keyframes btnPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .coin-obj {
            width: 45px; height: 45px; background: radial-gradient(circle, #ffd700, #ff8f00);
            border-radius: 50%; border: 2px solid #b8860b; cursor: grab;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #5d4037; box-shadow: 0 3px 0 #5d4037;
        }

        .lock-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            padding: 20px; background: rgba(0,0,0,0.1); border-radius: 20px;
        }
        .rune-stone {
            width: 70px; height: 70px; background: #fff;
            border: 4px solid #673ab7; color: #512da8;
            border-radius: 12px; font-size: 1.8rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 0 #4527a0; transition: 0.2s;
            min-height: 44px; min-width: 44px;
        }
        .rune-stone:active { transform: translateY(4px) scale(0.95); box-shadow: 0 1px 0 #4527a0; }
        .rune-stone.solved {
            background: #81c784; border-color: #2e7d32; color: white;
            box-shadow: none; transform: translateY(4px); cursor: default;
        }

        .magic-world {
            width: 100%; height: 100%; background: linear-gradient(135deg, #311b92, #673ab7);
            border-radius: 20px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; text-align: center;
        }

        #setup-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.92);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
        }
        .setup-panel { 
            background: white; padding: 30px; border-radius: 25px; 
            text-align: center; width: 85%; max-width: 350px; 
        }
        .hidden { display: none !important; }
        
        input, textarea, button {
            font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
        }

        /* ========== ç§»åŠ¨ç«¯è‡ªé€‚åº”æ ·å¼ ========== */
        /* å°å±å¹•æ‰‹æœº (ç«–å±) */
        @media (max-width: 480px) {
            #game-stage {
                width: 100vw;
                height: 100dvh;
                max-width: none;
                max-height: none;
                border-radius: 0;
                padding: 10px;
            }
            
            .card, .rune-stone {
                width: 65px;
                height: 65px;
                font-size: 1.5rem;
                margin: 4px;
            }
            
            .arcade-box {
                width: 90vw;
                height: 50vh;
                transform: scale(0.9);
                transform-origin: center;
            }
            
            #clue-tray {
                height: 60px;
                min-width: 70vw;
            }
            
            .header {
                font-size: 0.9rem;
                padding: 3px 5px;
            }
            
            #msg-hint {
                font-size: 0.8rem;
                max-width: 60%;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .coin-status {
                font-size: 1rem;
                padding: 8px 15px;
                margin-bottom: 10px;
            }
            
            .bottom-ui {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--panel);
                padding: 5px 10px;
                z-index: 100;
                height: auto;
            }
            
            #level-content {
                padding-bottom: 100px;
            }
            
            .control-panel {
                margin-top: 20px;
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }
            
            .coin-slot {
                height: 45px;
            }
            
            .start-btn {
                width: 60px;
                height: 60px;
                font-size: 0.8rem;
            }
            
            html {
                font-size: 14px;
            }
        }

        /* ä¸­ç­‰å±å¹•æ‰‹æœº (æ¨ªå±/å°å¹³æ¿) */
        @media (min-width: 481px) and (max-width: 768px) {
            #game-stage {
                width: 95vw;
                height: 95vh;
                max-width: none;
            }
            
            .card, .rune-stone {
                width: 70px;
                height: 70px;
                font-size: 1.6rem;
            }
            
            .arcade-box {
                width: 85vw;
                height: 55vh;
            }
            
            #clue-tray {
                height: 70px;
            }
            
            .header {
                font-size: 1rem;
            }
        }

        /* å¹³æ¿è®¾å¤‡ */
        @media (min-width: 769px) and (max-width: 1024px) {
            #game-stage {
                max-width: 90vw;
                max-height: 90vh;
            }
            
            .arcade-box {
                width: 70vw;
                height: 60vh;
            }
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-height: 500px) and (orientation: landscape) {
            #game-stage {
                flex-direction: row;
                padding: 5px;
            }
            
            .header {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                z-index: 10;
                background: var(--panel);
            }
            
            #level-content {
                margin-top: 40px;
            }
            
            .bottom-ui {
                position: absolute;
                bottom: 0;
                width: 100%;
            }
            
            .arcade-box {
                width: 50vw;
                height: 85vh;
                margin: 0 auto;
            }
            
            .bottom-ui {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                height: auto;
                padding: 10px;
            }
            
            #clue-tray {
                width: 50%;
                height: 60px;
            }
            
            #level-content {
                padding-bottom: 80px;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .card, .rune-stone, .coin-obj, .start-btn, #play-btn-L4 {
                cursor: default;
                -webkit-tap-highlight-color: transparent;
            }
            
            .card:active, .rune-stone:active, .start-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s;
            }
            
            .coin-slot::after {
                content: '';
                position: absolute;
                top: -10px;
                bottom: -10px;
                left: -10px;
                right: -10px;
            }
            
            .clue-item, .card[draggable="true"] {
                touch-action: manipulation;
            }
        }

        /* é«˜DPIå±å¹•ä¼˜åŒ– */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .card, .rune-stone, .coin-obj {
                border-width: 2px;
            }
        }

        /* æš—è‰²æ¨¡å¼æ”¯æŒ */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #1a1a2e;
                --panel: #16213e;
                --door-bg: #311b92;
            }
            
            body {
                background-color: var(--bg);
                color: #e0e0e0;
            }
            
            #game-stage {
                background: var(--panel);
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            }
            
            .header {
                color: #bbbbbb;
                border-bottom-color: #2d3748;
            }
            
            .card, .rune-stone {
                background: #2d3748;
                color: #ffffff;
                border-color: #4a5568;
            }
            
            .clue-item {
                background: #2d3748;
                border-color: #4a5568;
            }
            
            #clue-tray {
                background: rgba(255, 126, 95, 0.1);
                border-color: var(--p);
            }
            
            .setup-panel {
                background: #2d3748;
                color: #e0e0e0;
            }
            
            #words-input {
                background: #4a5568;
                color: #ffffff;
                border-color: #718096;
            }
        }

        /* é˜²æ­¢æ–‡å­—è¿‡å° */
        @media (max-width: 360px) {
            html {
                font-size: 14px;
            }
            
            .card, .rune-stone {
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }
            
            #clue-tray {
                height: 55px;
            }
            
            .clue-char {
                font-size: 0.9rem;
            }
            
            .clue-pinyin {
                font-size: 0.5rem;
            }
        }

        /* è¶…å¤§å±å¹•ä¼˜åŒ– */
        @media (min-width: 1400px) {
            #game-stage {
                max-width: 1000px;
                max-height: 800px;
            }
            
            .card, .rune-stone {
                width: 85px;
                height: 85px;
                font-size: 2rem;
            }
        }

        /* å…¨é¢å±æ‰‹æœºé€‚é… */
        @supports (padding: max(0px)) {
            body {
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            #game-stage {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
                padding-top: max(15px, env(safe-area-inset-top));
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }
            
            .bottom-ui {
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
        }

        /* åŠ¨ç”»æ€§èƒ½ä¼˜åŒ– */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* æ–¹å‘ç‰¹å®šçš„å¸ƒå±€ */
        .portrait-mode .arcade-box {
            width: 90vw;
            height: 50vh;
        }

        .landscape-mode .arcade-box {
            width: 50vw;
            height: 80vh;
        }

        /* è§¦æ‘¸æ¿€æ´»çŠ¶æ€ */
        .touch-active {
            opacity: 0.7;
            transform: scale(0.95);
        }

        /* è®¾ç½®é¡µé¢æŒ‰é’® */
        .setup-panel button {
            padding: 12px 40px;
            background: var(--p);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            min-height: 44px;
            font-size: 16px;
        }
        
        .setup-panel button:active {
            transform: scale(0.95);
        }

        #words-input {
            width: 85%;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1rem;
        }

        /* é­”æ³•ä¹å›­æŒ‰é’® */
        .shop-btn {
            padding: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: #fff;
            font-weight: bold;
            min-height: 44px;
        }
        
        .shop-btn.special {
            background: gold;
        }
        
        .shop-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body id="main-body">

    <div id="setup-screen">
        <div class="setup-panel">
            <h2 style="color:var(--p)">ğŸ¦ æ±‰å­—æ¢é™©å¯åŠ¨</h2>
            <p>è¾“å…¥è¦å­¦ä¹ çš„æ±‰å­—ï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼‰ï¼š</p>
            <input type="text" id="words-input" value="å±± æ°´ æ—¥ æœˆ" placeholder="ä¾‹å¦‚ï¼šå±± æ°´ æ—¥ æœˆ">
            <br><br>
            <button onclick="Game.start()">å‡ºå‘ï¼</button>
        </div>
    </div>

    <div id="game-stage">
        <div class="header">
            <div id="level-tag">å…³å¡: 1/4</div>
            <div id="msg-hint" style="color: var(--p); font-size: 0.95rem;"></div>
        </div>
        <div id="level-content"></div>
        <div class="bottom-ui">
            <div id="clue-tray"></div>
            <div class="coin-status">ğŸ’° <span id="coin-val">0</span></div>
        </div>
    </div>

<script>
const PinyinDict = {
    "å±±":"shÄn","æ°´":"shuÇ","æ—¥":"rÃ¬","æœˆ":"yuÃ¨","å¤©":"tiÄn","åœ°":"dÃ¬",
    "äºº":"rÃ©n","å£":"kÇ’u","æ‰‹":"shÇ’u","è¶³":"zÃº","å¤§":"dÃ ","å°":"xiÇo",
    "å¤š":"duÅ","å°‘":"shÇo","æœ¨":"mÃ¹","ç«":"huÇ’","åœŸ":"tÇ”","é‡‘":"jÄ«n"
};

const AudioSys = {
    speak(t) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'zh-CN'; u.rate = 0.85;
        window.speechSynthesis.speak(u);
    },
    playTone(freq, type='sine', dur=0.3) {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = type; osc.frequency.value = freq; osc.connect(g); g.connect(ctx.destination);
        osc.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
        osc.stop(ctx.currentTime + dur);
    }
};

// è§¦æ‘¸æ”¯æŒæ¨¡å—
const TouchSupport = {
    init() {
        // ä¸ºè§¦æ‘¸è®¾å¤‡ä¼˜åŒ–äº¤äº’
        if ('ontouchstart' in window) {
            // æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬
            document.addEventListener('touchstart', this.handleTouchStart, { passive: true });
            document.addEventListener('touchend', this.handleTouchEnd, { passive: true });
            
            // é˜²æ­¢åŒå‡»ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }
    },
    
    handleTouchStart(e) {
        const target = e.target;
        if (target.classList.contains('card') || 
            target.classList.contains('rune-stone') ||
            target.classList.contains('start-btn') ||
            target.classList.contains('shop-btn') ||
            target.classList.contains('coin-obj')) {
            target.classList.add('touch-active');
        }
    },
    
    handleTouchEnd(e) {
        document.querySelectorAll('.touch-active').forEach(el => {
            el.classList.remove('touch-active');
        });
    }
};

// å±å¹•æ–¹å‘æ£€æµ‹
const ScreenOrientation = {
    isPortrait: window.innerHeight > window.innerWidth,
    
    init() {
        this.updateOrientationClass();
        window.addEventListener('resize', this.handleResize.bind(this));
        window.addEventListener('orientationchange', () => {
            setTimeout(this.handleResize.bind(this), 100);
        });
    },
    
    handleResize() {
        const newIsPortrait = window.innerHeight > window.innerWidth;
        if (newIsPortrait !== this.isPortrait) {
            this.isPortrait = newIsPortrait;
            this.updateOrientationClass();
        }
    },
    
    updateOrientationClass() {
        document.body.classList.remove('portrait-mode', 'landscape-mode');
        document.body.classList.add(this.isPortrait ? 'portrait-mode' : 'landscape-mode');
    }
};

const Game = {
    words: [], collected: [], coins: 0, level: 1, walletSize: 0,
    
    start() {
        // ä»æœ¬åœ°å­˜å‚¨è¯»å–ç´¯è®¡é‡‘å¸
        const savedCoins = localStorage.getItem('hjtx_total_coins');
        this.coins = savedCoins ? parseInt(savedCoins) : 0;

        const raw = document.getElementById('words-input').value.trim();
        this.words = raw.split(/\s+/).filter(x => x);
        if(this.words.length < 1) {
            alert("è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæ±‰å­—");
            return;
        }
        
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-stage').style.display = 'flex';
        
        // åˆå§‹åŒ–è§¦æ‘¸æ”¯æŒå’Œå±å¹•æ–¹å‘æ£€æµ‹
        TouchSupport.init();
        ScreenOrientation.init();
        
        this.initL1();
    },

    updateUI() {
        document.getElementById('level-tag').textContent = `å…³å¡: ${this.level}/4`;
        const cVal = document.getElementById('coin-val');
        if (cVal.textContent != this.coins) {
            cVal.textContent = this.coins;
            document.querySelector('.coin-status').classList.add('coin-pop');
            setTimeout(() => document.querySelector('.coin-status').classList.remove('coin-pop'), 300);
            // é‡‘å¸å˜åŠ¨å³ä¿å­˜ï¼Œå®ç°è·¨å±€ç´¯è®¡
            localStorage.setItem('hjtx_total_coins', this.coins);
        }
    },

    setHint(t) { 
        const hintEl = document.getElementById('msg-hint');
        hintEl.textContent = t;
        // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šé•¿æ–‡æœ¬è‡ªåŠ¨æ»šåŠ¨
        if (t.length > 20 && window.innerWidth < 768) {
            hintEl.style.animation = 'marquee 10s linear infinite';
        } else {
            hintEl.style.animation = '';
        }
    },

    addClue(w) {
        if(this.collected.includes(w)) return;
        this.collected.push(w);
        const tray = document.getElementById('clue-tray');
        const item = document.createElement('div');
        item.className = 'clue-item';
        item.innerHTML = `<span class="clue-pinyin">${PinyinDict[w]||''}</span><span class="clue-char">${w}</span>`;
        tray.appendChild(item);
        tray.scrollLeft = tray.scrollWidth;
    },

    initL1() {
        this.level = 1; 
        this.updateUI();
        this.setHint("ç®—å‡ºå¾—æ•°ï¼Œç‚¹å‡»æ­£ç¡®çš„æ•°å­—ï¼");
        const cont = document.getElementById('level-content');
        let idx = 0;
        
        const renderTask = () => {
            if(idx >= this.words.length) return setTimeout(() => this.initL2(), 1200);
            const a = Math.floor(Math.random()*5)+1, b = Math.floor(Math.random()*4)+1;
            cont.innerHTML = `
                <div style="font-size:3rem; margin-bottom:30px; font-weight:bold; color:#555; text-align:center;">
                    ${a} + ${b} = ?
                </div>
                <div id="L1-grid" style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;"></div>`;
            
            const grid = document.getElementById('L1-grid');
            [a+b, a+b+1, a+b-1].sort(()=>Math.random()-0.5).forEach(v => {
                const c = document.createElement('div');
                c.className = 'card'; 
                c.textContent = v;
                c.onclick = () => {
                    if(v === a+b) {
                        AudioSys.playTone(600); 
                        const w = this.words[idx];
                        c.innerHTML = `<span style="font-size:0.8rem; color:#666;">${PinyinDict[w]||''}</span><span style="font-size:1.5rem;">${w}</span>`;
                        c.style.background = "#fff9c4"; 
                        c.draggable = true;
                        c.ondragstart = (e) => { 
                            e.dataTransfer.setData('text/plain', w); 
                            document.getElementById('clue-tray').classList.add('drag-active'); 
                        };
                        c.ondragend = () => document.getElementById('clue-tray').classList.remove('drag-active');
                        AudioSys.speak(w);
                    } else {
                        AudioSys.playTone(150, 'square');
                    }
                };
                grid.appendChild(c);
            });
        };
        
        const tray = document.getElementById('clue-tray');
        tray.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„æ”¶é›†
        this.collected = [];
        
        tray.ondragover = e => e.preventDefault();
        tray.ondrop = e => { 
            e.preventDefault(); 
            tray.classList.remove('drag-active'); 
            const w = e.dataTransfer.getData('text/plain'); 
            if(w && !['gold'].includes(w)) { 
                this.addClue(w); 
                idx++; 
                renderTask(); 
            }
        };
        
        renderTask();
    },

    initL2() {
        this.level = 2; 
        this.updateUI();
        this.setHint("ç‚¹å‡»è¯»éŸ³å¯¹åº”çš„å­—ï¼Œèµšå–é‡‘å¸ï¼");
        const cont = document.getElementById('level-content');
        this.walletSize = 0;
        let queue = [...this.words].sort(() => Math.random() - 0.5);
        let qIndex = 0;
        
        const nextQ = () => {
            if(qIndex >= queue.length) return setTimeout(() => this.initL3(), 1500);
            const target = queue[qIndex];
            
            cont.innerHTML = `
                <div onclick="AudioSys.speak('${target}')" style="font-size:4rem; cursor:pointer; margin-bottom:20px; padding:20px; background:#f0f0f0; border-radius:50%;">
                    ğŸ”Š
                </div>
                <div style="font-size:0.9rem; margin-bottom:20px; color:#666;">ç‚¹å‡»å–‡å­é‡æ’­å£°éŸ³</div>
                <div id="L2-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px; max-width:300px;"></div>`;
            
            AudioSys.speak(target);
            const grid = document.getElementById('L2-grid');
            
            // ç”Ÿæˆé€‰é¡¹ï¼šæ­£ç¡®ç­”æ¡ˆ + éšæœºå¹²æ‰°é¡¹
            const options = new Set([target]);
            while(options.size < 6) {
                const randomWord = Object.keys(PinyinDict)[Math.floor(Math.random() * Object.keys(PinyinDict).length)];
                options.add(randomWord);
            }
            
            Array.from(options).slice(0, 6).sort(()=>Math.random()-0.5).forEach(w => {
                const c = document.createElement('div'); 
                c.className = 'card'; 
                c.textContent = w;
                c.onclick = () => { 
                    if(w === target) { 
                        AudioSys.playTone(1000); 
                        this.coins += 1; 
                        this.walletSize++; 
                        this.updateUI(); 
                        qIndex++; 
                        setTimeout(nextQ, 500); // å»¶è¿Ÿæ˜¾ç¤ºä¸‹ä¸€é¢˜ï¼Œè®©ç”¨æˆ·çœ‹åˆ°åé¦ˆ
                    } else { 
                        AudioSys.playTone(200, 'sawtooth'); 
                        c.style.background = "#ffebee"; // é”™è¯¯åé¦ˆ
                        setTimeout(() => c.style.background = "", 300);
                    } 
                };
                grid.appendChild(c);
            });
        };
        nextQ();
    },

    initL3() {
        this.level = 3; 
        this.updateUI();
        this.setHint(`æŠ•å…¥é‡‘å¸å¯åŠ¨æ¸¸æˆæœºï¼`);
        const cont = document.getElementById('level-content');
        
        // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šè°ƒæ•´å¸ƒå±€
        const isMobile = window.innerWidth < 768;
        const purseWidth = isMobile ? '80px' : '90px';
        
        cont.innerHTML = `
            <div style="display:flex; ${isMobile ? 'flex-direction:column; align-items:center; gap:20px;' : 'gap:20px; align-items:center;'}">
                <div id="purse" style="width:${purseWidth}; height:200px; display:flex; flex-wrap:wrap; align-content:flex-start; gap:5px; border:2px solid #ddd; border-radius:15px; padding:10px; overflow-y:auto; background:#fff;">
                    <div style="width:100%; text-align:center; font-size:0.8rem; color:#888;">é‡‘å¸é’±åŒ…</div>
                </div>
                <div class="arcade-box">
                    <div class="arcade-screen" id="arcade-scr">INSERT<br>COINS</div>
                    <div class="control-panel">
                        <div class="coin-slot" id="target-slot"></div>
                        <div id="btn-start" class="start-btn">START</div>
                    </div>
                </div>
            </div>`;
        
        const purse = document.getElementById('purse');
        // ç”Ÿæˆé’±åŒ…ä¸­çš„é‡‘å¸
        for(let i=0; i<this.walletSize; i++) { 
            const c = document.createElement('div'); 
            c.className = 'coin-obj'; 
            c.textContent = 'Â¥'; 
            c.draggable = true; 
            c.ondragstart = e => e.dataTransfer.setData('type', 'gold'); 
            purse.appendChild(c); 
        }
        
        let inserted = 0; 
        const req = this.walletSize; 
        const slot = document.getElementById('target-slot');
        
        slot.ondragover = e => e.preventDefault();
        slot.ondrop = e => {
            if(e.dataTransfer.getData('type') === 'gold' && purse.lastChild) {
                purse.lastChild.remove(); 
                AudioSys.playTone(1200);
                if(this.coins > 0) this.coins--; 
                this.updateUI();
                inserted++; 
                document.getElementById('arcade-scr').innerHTML = `å·²æŠ•å…¥<br>${inserted}/${req}`;
                if(inserted >= req) this.enableStartButton();
            }
        };
        
        // ç§»åŠ¨ç«¯è§¦æ‘¸æ‹–æ‹½æ”¯æŒ
        if ('ontouchstart' in window) {
            const coins = document.querySelectorAll('.coin-obj');
            coins.forEach(coin => {
                coin.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    coin.style.position = 'absolute';
                    coin.style.left = touch.clientX - 22 + 'px';
                    coin.style.top = touch.clientY - 22 + 'px';
                });
            });
        }
    },
    
    enableStartButton() {
        const btn = document.getElementById('btn-start');
        document.getElementById('arcade-scr').innerHTML = "å‡†å¤‡<br>å¼€å§‹";
        document.getElementById('arcade-scr').style.color = "#ffff00";
        btn.classList.add('active');
        btn.onclick = () => { 
            AudioSys.playTone(1500, 'square'); 
            btn.classList.remove('active'); 
            this.startMoleGame(); 
        };
    },
    
    startMoleGame() {
        const scr = document.getElementById('arcade-scr'); 
        scr.innerHTML = "";
        
        // é¡¶éƒ¨æ§åˆ¶æ 
        const topBar = document.createElement('div');
        topBar.style.cssText = "width:100%; height:30px; background:#222; color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:0.8rem; border-bottom:1px solid #444;";
        topBar.innerHTML = "ğŸ”Š ç‚¹å‡»é‡æ’­"; 
        scr.appendChild(topBar);
        
        // æ¸¸æˆç½‘æ ¼
        const grid = document.createElement('div');
        const isMobile = window.innerWidth < 768;
        const gridSize = isMobile ? '100px' : '125px';
        grid.style.cssText = `display:grid; grid-template-columns:repeat(3,1fr); width:100%; height:${gridSize}; gap:6px; padding:4px; box-sizing:border-box;`;
        scr.appendChild(grid);
        
        const holes = [];
        for(let i=0; i<3; i++) {
            const hole = document.createElement('div'); 
            hole.style.cssText = "background:#111; position:relative; overflow:hidden; border-radius:4px;";
            const mole = document.createElement('div'); 
            mole.style.cssText = "width:100%; height:100%; background:#ffa000; position:absolute; bottom:-100%; transition:bottom 0.2s; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#3e2723; cursor:pointer; font-size:1.5rem;";
            hole.appendChild(mole); 
            grid.appendChild(hole); 
            holes.push(mole);
        }
        
        let round = 0;
        const playRound = () => {
            if(round >= 5) return setTimeout(() => this.initL4(), 1000);
            const target = this.words[Math.floor(Math.random()*this.words.length)];
            const opts = [target, ...this.words.filter(w => w !== target).slice(0, 2)].sort(()=>Math.random()-0.5);
            
            topBar.onclick = () => AudioSys.speak(target);
            AudioSys.speak(target);
            
            holes.forEach((mole, idx) => {
                if (idx < opts.length) {
                    mole.textContent = opts[idx]; 
                    mole.style.background = "#ffa000"; 
                    mole.style.bottom = "0";
                    mole.onclick = () => {
                        if(opts[idx] === target) {
                            mole.style.background = "var(--green)"; 
                            AudioSys.playTone(1000);
                            this.coins += 2; 
                            this.updateUI(); 
                            round++;
                            holes.forEach(h => h.style.bottom = "-100%"); 
                            setTimeout(playRound, 1200);
                        } else { 
                            AudioSys.playTone(150, 'sawtooth'); 
                            mole.style.background = "#f44336";
                            setTimeout(() => mole.style.background = "#ffa000", 300);
                        }
                    };
                }
            });
        };
        playRound();
    },

    initL4() {
        this.level = 4; 
        this.updateUI();
        this.setHint("å¬å£°éŸ³ï¼ŒæŒ‰é¡ºåºè§£å¼€é­”æ³•é”ï¼");
        const cont = document.getElementById('level-content');
        
        cont.innerHTML = `
            <div style="font-size:3rem; margin-bottom:10px;">ğŸšª ğŸ”’</div>
            <div id="play-btn-L4" style="font-size:1.2rem; background:#eee; padding:12px 25px; border-radius:20px; cursor:pointer; margin-bottom:20px; min-height:44px; display:flex; align-items:center; gap:10px;">
                <span>ğŸ”Š</span> <span>ç‚¹å‡»å¬å¯†ç </span>
            </div>
            <div id="lock-grid" class="lock-grid"></div>`;
        
        const grid = document.getElementById('lock-grid');
        const puzzleWords = [...this.words].sort(() => Math.random() - 0.5);
        
        puzzleWords.forEach(w => {
            const btn = document.createElement('div'); 
            btn.className = 'rune-stone'; 
            btn.id = `rune-${w}`; 
            btn.textContent = w; 
            grid.appendChild(btn);
        });
        
        let sequence = [...this.words].sort(() => Math.random() - 0.5);
        let currentStep = 0;
        
        const askForNext = () => {
            if(currentStep >= sequence.length) return setTimeout(() => this.initMagicWorld(), 1500);
            const target = sequence[currentStep];
            const playBtn = document.getElementById('play-btn-L4');
            
            const playSound = () => { 
                AudioSys.speak("è¯·ç‚¹å‡» " + target); 
            };
            playBtn.onclick = playSound; 
            playSound();
            
            puzzleWords.forEach(w => {
                const btn = document.getElementById(`rune-${w}`);
                if(btn.classList.contains('solved')) return;
                btn.onclick = () => {
                    if(w === target) {
                        btn.classList.add('solved'); 
                        btn.onclick = null; 
                        AudioSys.playTone(880);
                        this.coins += 5; 
                        this.updateUI(); 
                        currentStep++; 
                        setTimeout(askForNext, 1000);
                    } else { 
                        AudioSys.playTone(150, 'sawtooth'); 
                        btn.style.background = "#ffebee";
                        setTimeout(() => btn.style.background = "", 300);
                        if(this.coins > 0) {
                            this.coins--; 
                            this.updateUI();
                        }
                    }
                };
            });
        };
        setTimeout(askForNext, 1000);
    },

    initMagicWorld() {
        this.level = "é€šå…³"; 
        this.updateUI();
        const cont = document.getElementById('level-content');
        
        cont.innerHTML = `
            <div class="magic-world">
                <h2>âœ¨ é­”æ³•ä¹å›­ âœ¨</h2>
                <div id="dancer" style="font-size:6rem; margin:20px 0;">ğŸ¦</div>
                <div style="background:rgba(255,255,255,0.2); padding:15px; border-radius:15px; margin-top:20px;">
                    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                        <button onclick="Game.doDance('ğŸ¦', 5)" class="shop-btn">ğŸ¦ è·³èˆ (5ğŸ’°)</button>
                        <button onclick="Game.doDance('ğŸ‰', 30)" class="shop-btn special">ğŸ‰ ç¥é¾™ (30ğŸ’°)</button>
                        <button onclick="Game.doDance('ğŸŒˆ', 15)" class="shop-btn">ğŸŒˆ å½©è™¹ (15ğŸ’°)</button>
                    </div>
                </div>
                <div style="margin-top:30px; font-size:0.9rem;">
                    ç´¯è®¡é‡‘å¸: <strong>${this.coins}</strong> ğŸ’°
                </div>
                <button onclick="location.reload()" style="margin-top:25px; border:1px solid #fff; background:transparent; color:#fff; padding:12px 30px; border-radius:20px; font-size:1rem; min-height:44px;">
                    å†æ¥ä¸€å±€
                </button>
            </div>`;
    },

    doDance(icon, cost) {
        if(this.coins < cost) {
            alert("é‡‘å¸ä¸è¶³ï¼");
            return;
        }
        this.coins -= cost; 
        this.updateUI();
        const d = document.getElementById('dancer'); 
        d.textContent = icon;
        d.animate([
            {transform:'scale(1)', opacity: 1},
            {transform:'scale(1.5) rotate(360deg)', opacity: 0.8},
            {transform:'scale(1)', opacity: 1}
        ], {duration:1000, iterations: 1});
        AudioSys.playTone(1000);
    }
};

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', () => {
    // æ·»åŠ æ–‡å­—æ»šåŠ¨åŠ¨ç”»
    const style = document.createElement('style');
    style.textContent = `
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        #msg-hint {
            white-space: nowrap;
            overflow: hidden;
        }
    `;
    document.head.appendChild(style);
    
    // åˆå§‹åŒ–å±å¹•æ–¹å‘æ£€æµ‹
    ScreenOrientation.init();
});

// æ·»åŠ ç§»åŠ¨ç«¯æ‹–æ‹½æ”¯æŒ
document.addEventListener('DOMContentLoaded', function() {
    if ('ontouchstart' in window) {
        document.addEventListener('touchmove', function(e) {
            if (e.target.classList.contains('coin-obj')) {
                e.preventDefault();
            }
        }, { passive: false });
    }
});
</script>
</body>
</html>
